<!DOCTYPE html>
<html>
<head>
  <title>WSO2 Analytics Dashboard</title>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/keen-dashboards.css">
  <link rel="stylesheet" href="assets/css/simple-sidebar.css">
  <link rel="stylesheet" href="assets/css/jquery.gridster.min.css">
  <link rel="stylesheet" href="assets/css/main.css">
</head>

<body class="application">

  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../">
          <span class="glyphicon glyphicon-stats"></span>
        </a>
        <a class="navbar-brand" href="./">Analytics Dashboard</a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-left">
          <li>
            <button type="button" class="btn btn-default navbar-btn" id="menu-toggle">
              <span class="glyphicon glyphicon-menu-hamburger" aria-hidden="true"></span>
            </button>
          </li>
          <li><a href="http://localhost/dashboard" title="Add Widget"><span class="glyphicon glyphicon glyphicon-th-large"></span></a></li>
          <li><a href="http://localhost/dashboard" title="New Dashboard"><span class="glyphicon glyphicon-plus-sign"></span></a></li>
          <li><a href="http://localhost/dashboard" title="Edit Dashboard"><span class="glyphicon glyphicon-pencil"></span></a></li>
          <li><a href="http://localhost/dashboard" title="Delete Dashboard"><span class="glyphicon glyphicon-remove-circle"></span></a></li>
        </ul>

        <ul class="nav navbar-nav navbar-right">
          <li><a href="datasets.html">Dataset Explorer</a></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dunith<span class="caret"></span></a>
            <ul class="dropdown-menu" role="menu">
              <li><a href="#">Preferences</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Nav header</li>
              <li><a href="#">Sign Out</a></li>
            </ul>
        </li>
        </ul>
      </div>
    </div>
  </div>

  <div id="wrapper">

    <!-- Sidebar -->
    <div id="sidebar-wrapper">

        <div class="panel panel-default">
          <div class="panel-body" id="sidebar">

          </div>
        </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <!-- <div class="container-fluid"> -->
            <div class="row">

                <div  class="gridster">
                  <ul id="canvas"></ul>
                </div>

            </div>
            <!-- /row -->

           <!-- <hr>
           <p class="small text-muted">Built with &#9829; by <a href="https://wso2.com">WSO2</a></p> -->

        <!-- </div>   -->
        <!-- /container -->
    </div>
    <!-- /#page-content-wrapper -->


  </div>
  <!-- /wrapper -->


  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/js/jquery.gridster.min.js"></script>
  <script src="assets/js/d3.min.js"></script>
  <script src="assets/js/vega.js"></script>
  <script src="assets/js/igviz.js"></script>
  <!-- // <script src="assets/js/jquery.gridster.min.js"></script> -->

  <!-- Menu Toggle Script -->
  <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

    $(document).ready(function() {
      //Draw the sidebar first
      drawSidebar();
    });

    function drawSidebar() {
      var sidebar = $("#sidebar");
      var listGroup = jQuery('<div/>', {
          class: 'list-group'
      });

      $.getJSON( "data/dashboards.json", function( data ) {
        // var groups = [];
        // data.forEach(function(d,index){
        //   var group = d.group;
        //   if($.inArray(group,groups) == -1) {
        //     groups.push(group);
        //   }
        // });   
        // var dashboards = groups.map(function (g,i){
        //   return {
        //     name : g,
        //     values : data.map(function(d,i) {
        //       if(d.group == g) { 
        //         return d.title;
        //       } 
        //       return -1;
        //     })
        //   }
        // });
        // // console.log(dashboards); 


        data.forEach(function (dashboard,index) {
          var item = jQuery('<a/>', {
            class: 'list-group-item',
            id: dashboard.id,
            href: '#',
            title: dashboard.title,
            text: dashboard.title
          }).appendTo(listGroup);


          item.on('click',function (e) {
            drawDashboard(dashboard.id);
          });
        });

      });
      listGroup.appendTo(sidebar);
    };

    function drawDashboard(dashboardId) {
      $.getJSON("data/dashboards/" + dashboardId + ".json",function (data) {
        var title = data.title;
        var widgets = data.widgets;
        //clean up the canvas
        $("#canvas").empty();

        var gridster = $("#canvas").gridster( {
            widget_base_dimensions: [100, 100],
            widget_margins: [5, 5],
            min_cols: 1,
            max_cols: 8,
            avoid_overlapped_widgets: false,
            autogenerate_stylesheet: true,

        }).data('gridster');

        //draw each widget
        for (var i = 0; i < widgets.length; i++) {
          drawWidget(gridster,widgets[i]);
        };

      });
    
    };

    function drawWidget(gridster,widgetId) {
      console.log("drawing widget " + widgetId); 
      $.getJSON("data/widgets/" + widgetId + ".json",function (widget) {
        //create a div element to render this widget on
        createCanvas(gridster,widget);

        //fetch the dataset definition
        var dataset = {
            "name" : "Sales",
            "type" : "pull",
            "refreshRate" : 1000,
            "columns" : ["Year:n","Sales:n","Expenses:n"],
            "datasource" : "Sales",
            "filters" : "" 
        };

        var dataTable = new igviz.DataTable();
        dataset.columns.forEach(function (element,index) {
            var tokens = element.split(":");
            dataTable.addColumn(tokens[0],tokens[1]);
        });
        //get some data
        dataTable.addRows([
                ["2004",  1000,      400],
                ["2005",  1170,      460],
                ["2006",  660,       1120],
                ["2007",  1030,      540]
            ]);

        //do some width hiegth manipulation
        widget.config.width = widget.dimensions.width * 100;        
        widget.config.height = widget.dimensions.height * 100;     

        console.log(widget.config);    

        //draw a line chart on div #scatter
        var chart = igviz.plot("#" + widget.id,widget.config,dataTable);

      });

    };

    function createCanvas(gridster,widget) {
      var canvas = $('#canvas');
      var container = jQuery('<li/>');

      var panel = jQuery('<div/>', {
        class: 'panel panel-default'
      });

      var panelBody = jQuery('<div/>', {
        class: 'panel-body',
        id: widget.id,
        text: widget.title
      }).appendTo(panel);

      panel.appendTo(container);
      container.appendTo(canvas);

      gridster.add_widget(container,widget.dimensions.width, widget.dimensions.height);

    }

     

  </script>

</body>
</html>
